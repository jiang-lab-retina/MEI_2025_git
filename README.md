# MEI Analysis Project

This project focuses on analyzing Most Exciting Inputs (MEI) array data, specifically relating retinal ganglion cell (RGC) firing patterns to visual stimuli (images). It includes scripts for data preparation, model training (using PyTorch), and analysis.

## Project Goal

The primary goal is to process electrophysiological recordings and associated image presentation data to understand how RGCs respond to different visual inputs. This involves:
1.  Preparing the raw MEA data and synchronizing it with image presentation times.
2.  Training a convolutional neural network (CNN) model to predict RGC firing rates based on the presented images.
3.  Analyzing the results, evaluating model performance, and potentially characterizing cell properties like receptive fields.

## Experiment procedure

- Freshly dissociated mouse retina was recorded by a high-density MEA recording system

- About 1200 images were projected on the retina for 0.5 second followed by 0.5 second of gray screen

- Light response was recorded as a firing timestamp and preprocessed to get firing rates.

## Important Data
- final_X_dict.pkl and final_Y_dict.pkl can be used directly for training. About 200 cells were included, and they should be trained separately.

- 2025_connected_image_to_firing_time.csv provides a link from the image to light responses (1-second responses)

- compressed_ILSVRC2012 contains the images used for the experiments in a dimension of [time, x, y]. Each time frame is one image displayed. Note: Each batch does not have exactly 300 images due to the selection of images.



## Setup

1.  **Clone the repository:**
    ```bash
    git clone <your-repository-url>
    cd MEI_2025_git 
    ```
2.  **Create a Python environment:** (Recommended using conda or venv)
    ```bash
    # Using conda
    conda create -n mei_env python=3.9 
    conda activate mei_env

    # Or using venv
    python -m venv mei_env
    source mei_env/bin/activate # On Windows use `mei_env\Scripts\activate`
    ```
3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

## Key Scripts

*   `MEI_analysis_data_prep.py`: Handles the initial data loading and preprocessing steps. This includes:
    *   Loading raw MEA data (potentially using `McsPyDataTools` and `jianglab`).
    *   Processing image data (compressing, aligning with recordings).
    *   Calculating spike-triggered averages (STA).
    *   Connecting image presentations to corresponding neural firing times.
    *   Generating intermediate data files (e.g., `.pkl`, `.csv`) for modeling.
    *   Finding receptive field centers based on STA.
*   `MEI_analysis_simple_model_best_result_by_202504.py`: Implements, trains, and evaluates a PyTorch CNN model (`RGCNet`) to predict RGC responses from input images.
    *   Loads preprocessed data generated by `MEI_analysis_data_prep.py`.
    *   Defines the CNN architecture.
    *   Includes functions for training the model (leveraging GPU if available - MPS or CUDA).
    *   Evaluates model performance (MSE, MAE) and visualizes predictions against true responses.
*   `MEI_analysis_helper.py`: Contains utility functions used by the main scripts, such as converting timestamps to frame numbers and calculating STAs.
*   `requirements.txt`: Lists the necessary Python packages and their versions.

## Usage

The scripts contain `if __name__ == "__main__"` blocks with example workflows. You can adapt these sections to run the desired analysis steps.

1.  **Data Preparation:** Run `MEI_analysis_data_prep.py` to process raw data and generate the necessary inputs for the model. You may need to adjust file paths and parameters within the script.
2.  **Model Training & Evaluation:** Run `MEI_analysis_simple_model_best_result_by_202504.py` to train the `RGCNet` model on the prepared data and evaluate its performance.

*(Note: Ensure that the required raw data files and image datasets like ILSVRC2012 are available in the expected locations or update the paths in the scripts accordingly.)*
